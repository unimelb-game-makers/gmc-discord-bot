name: Deploy to DigitalOcean

on:
  push:
    branches:
      - do
  workflow_dispatch:  # Allow manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.DROPLET_IP }} >> ~/.ssh/known_hosts

      - name: Deploy to Droplet
        env:
          DROPLET_IP: ${{ secrets.DROPLET_IP }}
          DROPLET_USER: root
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no $DROPLET_USER@$DROPLET_IP << 'ENDSSH'
            set -e

            echo "========================================="
            echo "Starting deployment..."
            echo "========================================="

            # Navigate to project directory
            cd /root/gmc-discord-bot || {
              echo "Error: Project directory not found"
              exit 1
            }

            echo "Pulling latest changes from repository..."
            git pull origin main

            echo "Stopping existing containers..."
            docker compose down || true

            echo "Building Docker image..."
            docker compose build

            echo "Starting containers..."
            docker compose up -d

            echo "Waiting for container to start..."
            sleep 5

            echo "========================================="
            echo "Container status:"
            echo "========================================="
            docker compose ps

            echo ""
            echo "========================================="
            echo "Recent logs (last 50 lines):"
            echo "========================================="
            docker compose logs --tail=50

            echo ""
            echo "========================================="
            echo "Health check:"
            echo "========================================="
            if docker compose ps | grep -q "Up"; then
              echo "✓ Container is running"
              exit 0
            else
              echo "✗ Container is not running properly"
              docker compose logs --tail=100
              exit 1
            fi
          ENDSSH

      - name: Deployment Status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "✓ Deployment successful!"
          else
            echo "✗ Deployment failed!"
            exit 1
          fi
