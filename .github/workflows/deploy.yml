name: Deploy to DigitalOcean

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.DROPLET_IP }} >> ~/.ssh/known_hosts

      - name: Write .env to Droplet
        env:
          DROPLET_IP: ${{ secrets.DROPLET_IP }}
          DROPLET_USER: root
          DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          NOTION_AUTHENTICATION_TOKEN: ${{ secrets.NOTION_AUTHENTICATION_TOKEN }}
          NOTION_EVENTS_DATABASE_ID: ${{ secrets.NOTION_EVENTS_DATABASE_ID }}
          NOTION_TASKS_DATABASE_ID: ${{ secrets.NOTION_TASKS_DATABASE_ID }}
          NOTION_PEOPLE_DATABASE_ID: ${{ secrets.NOTION_PEOPLE_DATABASE_ID }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          cat > /tmp/deploy.env << EOF
          DISCORD_BOT_TOKEN=${DISCORD_BOT_TOKEN}
          NOTION_AUTHENTICATION_TOKEN=${NOTION_AUTHENTICATION_TOKEN}
          NOTION_EVENTS_DATABASE_ID=${NOTION_EVENTS_DATABASE_ID}
          NOTION_TASKS_DATABASE_ID=${NOTION_TASKS_DATABASE_ID}
          NOTION_PEOPLE_DATABASE_ID=${NOTION_PEOPLE_DATABASE_ID}
          OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
          EOF
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no $DROPLET_USER@$DROPLET_IP "mkdir -p /root/gmc-discord-bot"
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no /tmp/deploy.env $DROPLET_USER@$DROPLET_IP:/root/gmc-discord-bot/.env

      - name: Deploy to Droplet
        env:
          DROPLET_IP: ${{ secrets.DROPLET_IP }}
          DROPLET_USER: root
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no $DROPLET_USER@$DROPLET_IP << 'ENDSSH'
            set -e

            echo "========================================="
            echo "Starting deployment..."
            echo "========================================="

            # Check if project directory exists
            if [ ! -d "/root/gmc-discord-bot" ]; then
              echo "Project directory not found. Cloning repository..."
              cd /root
              git clone https://github.com/unimelb-game-makers/gmc-discord-bot.git
              cd gmc-discord-bot

              echo "Creating working_memory directory..."
              mkdir -p working_memory
            else
              echo "Project directory found. Updating..."
              cd /root/gmc-discord-bot

              echo "Pulling latest changes from repository..."
              git pull origin main
            fi

            echo "Stopping existing containers..."
            docker compose down || true

            echo "Building Docker image..."
            docker compose build

            echo "Starting containers..."
            docker compose up -d

            echo "Waiting for container to start..."
            sleep 5

            echo "========================================="
            echo "Container status:"
            echo "========================================="
            docker compose ps

            echo ""
            echo "========================================="
            echo "Recent logs (last 50 lines):"
            echo "========================================="
            docker compose logs --tail=50

            echo ""
            echo "========================================="
            echo "Health check:"
            echo "========================================="
            if docker compose ps | grep -q "Up"; then
              echo "✓ Container is running"
              exit 0
            else
              echo "✗ Container is not running properly"
              docker compose logs --tail=100
              exit 1
            fi
          ENDSSH

      - name: Deployment Status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "✓ Deployment successful!"
          else
            echo "✗ Deployment failed!"
            exit 1
          fi
